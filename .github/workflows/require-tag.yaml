name: Require Tag on PR to Master
on:
  pull_request:
    branches:
      - master
jobs:
  check-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # important pour r√©cup√©rer tout l'historique et les tags
      - name: Verify new tag format and increment
        run: |
          # R√©cup√®re tous les tags
          git fetch --tags

          # Tag courant (celui pointant sur HEAD)
          CURRENT_TAG=$(git tag --points-at HEAD | sort -V | tail -n1)

          if [ -z "$CURRENT_TAG" ]; then
            echo "‚ùå ERROR: No tag found on the current commit."
            echo "Please create a tag before merging to master (e.g. v1.2.3)"
            exit 1
          fi

          # V√©rifie le format du tag
          if [[ ! "$CURRENT_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå ERROR: Tag must follow semantic versioning and start with 'v' (e.g. v1.2.3)"
            exit 1
          fi

          echo "‚úÖ Tag format is valid: $CURRENT_TAG"

          # Dernier tag officiel dans master
          LAST_TAG=$(git tag --list 'v*' --sort=-v:refname | head -n1)

          if [ -z "$LAST_TAG" ]; then
            echo "‚ÑπÔ∏è No previous tag found, assuming first release."
            exit 0
          fi

          echo "üîé Last tag found: $LAST_TAG"

          # Supprime le 'v' et compare les parties
          strip_v() { echo "$1" | sed 's/^v//'; }
          IFS='.' read -r L_MAJOR L_MINOR L_PATCH <<< "$(strip_v "$LAST_TAG")"
          IFS='.' read -r C_MAJOR C_MINOR C_PATCH <<< "$(strip_v "$CURRENT_TAG")"

          # V√©rifie progression valide
          if [ "$C_MAJOR" -eq "$L_MAJOR" ] && [ "$C_MINOR" -eq "$L_MINOR" ]; then
            if [ "$C_PATCH" -ne $((L_PATCH + 1)) ]; then
              echo "‚ùå ERROR: Patch version must increment by exactly +1 (e.g. $LAST_TAG ‚Üí v$L_MAJOR.$L_MINOR.$((L_PATCH + 1)))"
              exit 1
            fi
            echo "‚úÖ Patch version increment validated."
            exit 0
          fi

          if [ "$C_MAJOR" -eq "$L_MAJOR" ] && [ "$C_MINOR" -eq $((L_MINOR + 1)) ] && [ "$C_PATCH" -eq 0 ]; then
            echo "‚úÖ Minor version increment validated."
            exit 0
          fi

          if [ "$C_MAJOR" -eq $((L_MAJOR + 1)) ] && [ "$C_MINOR" -eq 0 ] && [ "$C_PATCH" -eq 0 ]; then
            echo "‚úÖ Major version increment validated."
            exit 0
          fi

          echo "‚ùå ERROR: Invalid version jump."
          echo "Allowed increments are:"
          echo "- Patch: vX.Y.Z ‚Üí vX.Y.(Z+1)"
          echo "- Minor: vX.Y.Z ‚Üí vX.(Y+1).0"
          echo "- Major: vX.Y.Z ‚Üí v(X+1).0.0"
          exit 1
