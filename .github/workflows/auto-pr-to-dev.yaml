name: Auto PR to Dev

on:
  workflow_run:
    workflows: ["CI/CD"]
    types: [completed]
    branches:
      - 'feature/**'
      - 'fix/**'
      - 'hotfix/**'
      - 'refactor/**'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    # Ne cr√©er la PR QUE si le workflow CI/CD a r√©ussi
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Check if PR already exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
          pr_number=$(gh pr list --head "$BRANCH_NAME" --base dev --json number --jq '.[0].number // empty')
          if [ -n "$pr_number" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
            echo "‚úÖ PR #$pr_number already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "üîç No existing PR found"
          fi
      
      - name: Create Pull Request to dev
        if: steps.check.outputs.exists == 'false'
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ github.event.workflow_run.head_branch }}
          destination_branch: dev
          pr_title: "[${{ github.event.workflow_run.head_branch }}] Auto PR to dev"
          pr_body: |
            ## ü§ñ Automated Pull Request
            
            This PR was automatically created from branch `${{ github.event.workflow_run.head_branch }}` to `dev`.
            
            **Branch:** `${{ github.event.workflow_run.head_branch }}`
            **Target:** `dev`
            **Author:** @${{ github.actor }}
            **CI Status:** ‚úÖ All tests passed
            
            Please review the changes and merge when ready.
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_draft: false
          pr_allow_empty: false
