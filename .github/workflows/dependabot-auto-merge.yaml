# ============================================================================
# Workflow de Fusion Automatique pour Dependabot
# ============================================================================
# Ce workflow g√®re automatiquement les pull requests cr√©√©es par Dependabot
# pour les mises √† jour de d√©pendances.
#
# Strat√©gie :
# - Auto-merge automatique pour les mises √† jour PATCH et MINOR (s√ªres)
# - Commentaire de warning pour les mises √† jour MAJOR (review manuelle requise)
#
# Exemple :
# - 1.2.3 ‚Üí 1.2.4 (PATCH) : ‚úÖ Fusion automatique
# - 1.2.3 ‚Üí 1.3.0 (MINOR) : ‚úÖ Fusion automatique
# - 1.2.3 ‚Üí 2.0.0 (MAJOR) : ‚ö†Ô∏è  Review manuelle requise (breaking changes)
# ============================================================================

name: Fusion Automatique Dependabot

# D√©clenchement : sur toutes les pull requests ciblant la branche master
on:
  pull_request:
    branches: [master]

# Permissions n√©cessaires pour modifier les PRs
permissions:
  contents: write        # Pour fusionner la PR
  pull-requests: write   # Pour modifier et commenter la PR

jobs:
  auto-merge:
    name: Fusion Automatique Dependabot
    runs-on: ubuntu-latest
    
    # Condition : Ne s'ex√©cute que pour les PRs cr√©√©es par Dependabot
    if: github.actor == 'dependabot[bot]'
    
    steps:
      # -----------------------------------------------------------------------
      # √âtape 1 : R√©cup√©ration des m√©tadonn√©es Dependabot
      # -----------------------------------------------------------------------
      # Extrait les informations sur la mise √† jour (type, version, etc.)
      # Utilise l'action officielle Dependabot pour parser les m√©tadonn√©es
      - name: M√©tadonn√©es Dependabot
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      # -----------------------------------------------------------------------
      # √âtape 2 : Activation de la fusion automatique (PATCH et MINOR)
      # -----------------------------------------------------------------------
      # Active l'auto-merge pour les mises √† jour s√ªres qui ne contiennent
      # g√©n√©ralement pas de breaking changes :
      # - version-update:semver-patch : correctifs de bugs (1.0.0 ‚Üí 1.0.1)
      # - version-update:semver-minor : nouvelles fonctionnalit√©s (1.0.0 ‚Üí 1.1.0)
      #
      # M√©thode squash : combine tous les commits de la PR en un seul
      - name: Activer la fusion automatique
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # -----------------------------------------------------------------------
      # √âtape 3 : Commentaire d'avertissement pour les MAJOR
      # -----------------------------------------------------------------------
      # Pour les mises √† jour majeures (1.x.x ‚Üí 2.0.0), ne pas fusionner
      # automatiquement car elles peuvent contenir des breaking changes.
      # Poste un commentaire pour alerter l'√©quipe qu'une review est n√©cessaire
      - name: Commentaire sur mise √† jour majeure
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è **Mise √† jour majeure d√©tect√©e !**\n\nCette PR n√©cessite une review manuelle car c\'est une version majeure qui peut contenir des breaking changes (modifications incompatibles avec la version pr√©c√©dente).\n\nüîç Veuillez v√©rifier le changelog et tester minutieusement avant de fusionner.'
            })
