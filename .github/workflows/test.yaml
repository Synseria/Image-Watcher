# ============================================================================
# Workflow de Tests et Qualit√© du Code
# ============================================================================
# Ce workflow r√©utilisable ex√©cute les tests unitaires, le linter et g√©n√®re
# un rapport de couverture de code. Il est appel√© par d'autres workflows
# (comme ci-cd.yaml) pour centraliser la logique de test.
#
# Fonctionnalit√©s :
# - Linting du code (v√©rification des r√®gles de style)
# - Tests unitaires avec couverture de code
# - G√©n√©ration d'un rapport HTML de couverture
# - Publication du rapport sur GitHub Pages (branche master uniquement)
# ============================================================================

name: Tests

# Ce workflow est r√©utilisable et peut √™tre appel√© par d'autres workflows
on:
  workflow_call:

jobs:
  test:
    name: Tests et Lint
    runs-on: ubuntu-latest
    
    steps:
      # -----------------------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du code source
      # -----------------------------------------------------------------------
      - uses: actions/checkout@v5
      
      # -----------------------------------------------------------------------
      # √âtape 2 : Configuration de l'environnement Node.js
      # -----------------------------------------------------------------------
      - uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
      
      # -----------------------------------------------------------------------
      # √âtape 3 : Installation des d√©pendances
      # -----------------------------------------------------------------------
      - run: npm ci

      # -----------------------------------------------------------------------
      # √âtape 4 : Cr√©ation du fichier .env.test si n√©cessaire
      # -----------------------------------------------------------------------
      # Certains tests peuvent n√©cessiter des variables d'environnement
      # Cr√©e un fichier .env.test vide s'il n'existe pas d√©j√†
      - name: Cr√©er .env.test si manquant
        run: |
          if [ ! -f .env.test ]; then
            echo "Cr√©ation de .env.test avec les valeurs par d√©faut"
            touch .env.test
          fi

      # -----------------------------------------------------------------------
      # √âtape 5 : V√©rification du style de code (Linting)
      # -----------------------------------------------------------------------
      # Ex√©cute ESLint pour v√©rifier que le code respecte les r√®gles de style
      # et les bonnes pratiques d√©finies dans eslint.config.js
      - name: Lint
        run: npm run lint

      # -----------------------------------------------------------------------
      # √âtape 6 : Ex√©cution des tests avec couverture de code
      # -----------------------------------------------------------------------
      # Ex√©cute les tests unitaires avec Vitest et g√©n√®re un rapport de
      # couverture de code qui indique quelles lignes sont test√©es
      - name: Tests avec couverture de code
        run: npm run coverage -- --reporter=json --reporter=default --outputFile=test-results.json

      # -----------------------------------------------------------------------
      # √âtape 7 : G√©n√©ration du r√©sum√© de couverture
      # -----------------------------------------------------------------------
      # Cr√©e un r√©sum√© visible dans l'interface GitHub Actions
      # S'ex√©cute toujours, m√™me si les tests √©chouent (if: always())
      - name: R√©sum√© de couverture
        if: always()
        run: |
          echo "## üìä Rapport de Tests et Couverture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ===================================================================
          # PARTIE 1 : R√©sultats des Tests
          # ===================================================================
          if [ -f test-results.json ]; then
            echo "### üß™ R√©sultats des Tests" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            node -e "
              const fs = require('fs');
              const results = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
              
              let totalTests = 0;
              let passedTests = 0;
              let failedTests = 0;
              let skippedTests = 0;
              let duration = 0;
              
              const testFiles = [];
              
              // Parcourir tous les fichiers de test
              if (results.testResults) {
                results.testResults.forEach(file => {
                  const fileName = file.name.replace(process.cwd() + '/', '');
                  const fileTests = file.assertionResults || [];
                  
                  let filePassed = 0;
                  let fileFailed = 0;
                  let fileSkipped = 0;
                  
                  fileTests.forEach(test => {
                    totalTests++;
                    if (test.status === 'passed') {
                      passedTests++;
                      filePassed++;
                    } else if (test.status === 'failed') {
                      failedTests++;
                      fileFailed++;
                    } else if (test.status === 'skipped' || test.status === 'pending') {
                      skippedTests++;
                      fileSkipped++;
                    }
                  });
                  
                  if (fileTests.length > 0) {
                    testFiles.push({
                      name: fileName,
                      total: fileTests.length,
                      passed: filePassed,
                      failed: fileFailed,
                      skipped: fileSkipped,
                      duration: file.endTime - file.startTime
                    });
                  }
                  
                  duration += (file.endTime - file.startTime);
                });
              }
              
              // R√©sum√© global
              const successRate = totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : '0';
              const statusEmoji = failedTests === 0 ? '‚úÖ' : '‚ùå';
              
              console.log(\`\${statusEmoji} **Statut Global** : \${passedTests}/\${totalTests} tests r√©ussis (\${successRate}%)\`);
              console.log('');
              console.log('| M√©trique | Valeur |');
              console.log('|----------|--------|');
              console.log(\`| ‚úÖ R√©ussis | \${passedTests} |\`);
              console.log(\`| ‚ùå √âchou√©s | \${failedTests} |\`);
              console.log(\`| ‚è≠Ô∏è Ignor√©s | \${skippedTests} |\`);
              console.log(\`| ‚è±Ô∏è Dur√©e | \${(duration / 1000).toFixed(2)}s |\`);
              console.log('');
              
              if (testFiles.length > 0) {
                console.log('#### üìÅ D√©tails par Fichier');
                console.log('');
                console.log('| Fichier | Tests | R√©ussis | √âchou√©s | Ignor√©s | Dur√©e |');
                console.log('|---------|-------|---------|---------|---------|-------|');
                
                testFiles.forEach(file => {
                  const emoji = file.failed === 0 ? '‚úÖ' : '‚ùå';
                  const durationStr = (file.duration / 1000).toFixed(2) + 's';
                  console.log(\`| \${emoji} \${file.name} | \${file.total} | \${file.passed} | \${file.failed} | \${file.skipped} | \${durationStr} |\`);
                });
                
                console.log('');
              }
            " >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **R√©sultats des tests non disponibles**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ===================================================================
          # PARTIE 2 : Couverture de Code
          # ===================================================================
          if [ -f coverage/coverage-final.json ]; then
            echo "### üìà Couverture de Code" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extraction des m√©triques globales
            node -e "
              const fs = require('fs');
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-final.json', 'utf8'));
              
              let totalStatements = 0, coveredStatements = 0;
              let totalBranches = 0, coveredBranches = 0;
              let totalFunctions = 0, coveredFunctions = 0;
              let totalLines = 0, coveredLines = 0;
              
              const fileStats = [];
              
              for (const [file, data] of Object.entries(coverage)) {
                const fileName = file.replace(process.cwd() + '/', '');
                const s = data.s || {}, b = data.b || {}, f = data.f || {};
                
                const stmtTotal = Object.keys(s).length;
                const stmtCovered = Object.values(s).filter(v => v > 0).length;
                const branchTotal = Object.values(b).flat().length;
                const branchCovered = Object.values(b).flat().filter(v => v > 0).length;
                const funcTotal = Object.keys(f).length;
                const funcCovered = Object.values(f).filter(v => v > 0).length;
                const lineTotal = Object.keys(data.statementMap || {}).length;
                const lineCovered = Object.values(s).filter(v => v > 0).length;
                
                totalStatements += stmtTotal;
                coveredStatements += stmtCovered;
                totalBranches += branchTotal;
                coveredBranches += branchCovered;
                totalFunctions += funcTotal;
                coveredFunctions += funcCovered;
                totalLines += lineTotal;
                coveredLines += lineCovered;
                
                const stmtPct = stmtTotal > 0 ? (stmtCovered / stmtTotal * 100).toFixed(2) : '100.00';
                const branchPct = branchTotal > 0 ? (branchCovered / branchTotal * 100).toFixed(2) : '100.00';
                const funcPct = funcTotal > 0 ? (funcCovered / funcTotal * 100).toFixed(2) : '100.00';
                const linePct = lineTotal > 0 ? (lineCovered / lineTotal * 100).toFixed(2) : '100.00';
                
                fileStats.push({ fileName, stmtPct, branchPct, funcPct, linePct });
              }
              
              const globalStmtPct = totalStatements > 0 ? (coveredStatements / totalStatements * 100).toFixed(2) : '100.00';
              const globalBranchPct = totalBranches > 0 ? (coveredBranches / totalBranches * 100).toFixed(2) : '100.00';
              const globalFuncPct = totalFunctions > 0 ? (coveredFunctions / totalFunctions * 100).toFixed(2) : '100.00';
              const globalLinePct = totalLines > 0 ? (coveredLines / totalLines * 100).toFixed(2) : '100.00';
              
              console.log('#### üìä Couverture Globale');
              console.log('');
              console.log('| M√©trique | Couverture |');
              console.log('|----------|------------|');
              console.log(\`| üìù Statements | \${globalStmtPct}% (\${coveredStatements}/\${totalStatements}) |\`);
              console.log(\`| üåø Branches | \${globalBranchPct}% (\${coveredBranches}/\${totalBranches}) |\`);
              console.log(\`| ‚ö° Functions | \${globalFuncPct}% (\${coveredFunctions}/\${totalFunctions}) |\`);
              console.log(\`| üìÑ Lines | \${globalLinePct}% (\${coveredLines}/\${totalLines}) |\`);
              console.log('');
              console.log('#### üìÅ D√©tails par Fichier');
              console.log('');
              console.log('| Fichier | Statements | Branches | Functions | Lines |');
              console.log('|---------|------------|----------|-----------|-------|');
              
              fileStats
                .sort((a, b) => parseFloat(a.stmtPct) - parseFloat(b.stmtPct))
                .forEach(stat => {
                  const stmtEmoji = parseFloat(stat.stmtPct) >= 80 ? '‚úÖ' : parseFloat(stat.stmtPct) >= 50 ? '‚ö†Ô∏è' : '‚ùå';
                  console.log(\`| \${stat.fileName} | \${stmtEmoji} \${stat.stmtPct}% | \${stat.branchPct}% | \${stat.funcPct}% | \${stat.linePct}% |\`);
                });
            " >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Donn√©es de couverture non g√©n√©r√©es**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "üì¶ **T√©l√©chargez le rapport HTML complet** depuis les artifacts ci-dessous pour voir la couverture ligne par ligne" >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------------------------
      # √âtape 8 : Sauvegarde du rapport de couverture
      # -----------------------------------------------------------------------
      # Upload le dossier coverage/ comme artifact pour permettre de t√©l√©charger
      # et consulter le rapport HTML d√©taill√©
      # S'ex√©cute toujours, m√™me si les tests √©chouent
      - name: Upload de l'artifact de couverture
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30  # Conserv√© pendant 30 jours

      # -----------------------------------------------------------------------
      # √âtape 9 : Publication sur GitHub Pages (master uniquement)
      # -----------------------------------------------------------------------
      # Publie le rapport de couverture sur GitHub Pages pour un acc√®s facile
      # Uniquement pour la branche master et si toutes les √©tapes pr√©c√©dentes
      # ont r√©ussi
      - name: D√©ployer la couverture sur GitHub Pages
        if: github.ref == 'refs/heads/master' && success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage
          destination_dir: coverage  # Publi√© sous /coverage sur GitHub Pages
