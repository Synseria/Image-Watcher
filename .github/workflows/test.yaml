# ============================================================================
# Workflow de Tests et Qualit√© du Code
# ============================================================================
# Ce workflow r√©utilisable ex√©cute les tests unitaires, le linter et g√©n√®re
# un rapport de couverture de code. Il est appel√© par d'autres workflows
# (comme ci-cd.yaml) pour centraliser la logique de test.
#
# Fonctionnalit√©s :
# - Linting du code (v√©rification des r√®gles de style)
# - Tests unitaires avec couverture de code
# - G√©n√©ration d'un rapport HTML de couverture
# - Publication du rapport sur GitHub Pages (branche master uniquement)
# ============================================================================

name: Tests

# Ce workflow est r√©utilisable et peut √™tre appel√© par d'autres workflows
on:
  workflow_call:

jobs:
  test:
    name: Tests et Lint
    runs-on: ubuntu-latest
    
    steps:
      # -----------------------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du code source
      # -----------------------------------------------------------------------
      - uses: actions/checkout@v5
      
      # -----------------------------------------------------------------------
      # √âtape 2 : Configuration de l'environnement Node.js
      # -----------------------------------------------------------------------
      - uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
      
      # -----------------------------------------------------------------------
      # √âtape 3 : Installation des d√©pendances
      # -----------------------------------------------------------------------
      - run: npm ci

      # -----------------------------------------------------------------------
      # √âtape 4 : Cr√©ation du fichier .env.test si n√©cessaire
      # -----------------------------------------------------------------------
      # Certains tests peuvent n√©cessiter des variables d'environnement
      # Cr√©e un fichier .env.test vide s'il n'existe pas d√©j√†
      - name: Cr√©er .env.test si manquant
        run: |
          if [ ! -f .env.test ]; then
            echo "Cr√©ation de .env.test avec les valeurs par d√©faut"
            touch .env.test
          fi

      # -----------------------------------------------------------------------
      # √âtape 5 : V√©rification du style de code (Linting)
      # -----------------------------------------------------------------------
      # Ex√©cute ESLint pour v√©rifier que le code respecte les r√®gles de style
      # et les bonnes pratiques d√©finies dans eslint.config.js
      - name: Lint
        run: npm run lint

      # -----------------------------------------------------------------------
      # √âtape 6 : Ex√©cution des tests avec couverture de code
      # -----------------------------------------------------------------------
      # Ex√©cute les tests unitaires avec Vitest et g√©n√®re un rapport de
      # couverture de code qui indique quelles lignes sont test√©es
      - name: Tests avec couverture de code
        run: npm run coverage

      # -----------------------------------------------------------------------
      # √âtape 7 : G√©n√©ration du r√©sum√© de couverture
      # -----------------------------------------------------------------------
      # Cr√©e un r√©sum√© visible dans l'interface GitHub Actions
      # S'ex√©cute toujours, m√™me si les tests √©chouent (if: always())
      - name: R√©sum√© de couverture
        if: always()
        run: |
          echo "## üìä Rapport de Couverture de Code" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-final.json ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "Rapports de couverture g√©n√©r√©s avec succ√®s" >> $GITHUB_STEP_SUMMARY
            echo "Consultez le rapport HTML d√©taill√© dans les artifacts ci-dessous" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Donn√©es de couverture non g√©n√©r√©es" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **T√©l√©chargez le rapport HTML complet** depuis les artifacts ci-dessous pour voir la couverture ligne par ligne" >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------------------------
      # √âtape 8 : Sauvegarde du rapport de couverture
      # -----------------------------------------------------------------------
      # Upload le dossier coverage/ comme artifact pour permettre de t√©l√©charger
      # et consulter le rapport HTML d√©taill√©
      # S'ex√©cute toujours, m√™me si les tests √©chouent
      - name: Upload de l'artifact de couverture
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30  # Conserv√© pendant 30 jours

      # -----------------------------------------------------------------------
      # √âtape 9 : Publication sur GitHub Pages (master uniquement)
      # -----------------------------------------------------------------------
      # Publie le rapport de couverture sur GitHub Pages pour un acc√®s facile
      # Uniquement pour la branche master et si toutes les √©tapes pr√©c√©dentes
      # ont r√©ussi
      - name: D√©ployer la couverture sur GitHub Pages
        if: github.ref == 'refs/heads/master' && success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage
          destination_dir: coverage  # Publi√© sous /coverage sur GitHub Pages
