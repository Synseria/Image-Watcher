name: CI/CD

on:
  push:
    branches: ['**']
    tags: ['v*']
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 1Ô∏è‚É£ Build de l'application TypeScript
  build:
    name: 1Ô∏è‚É£ Construction de l'application
    uses: ./.github/workflows/build.yaml

  # 2Ô∏è‚É£ Tests + Lint + Code Coverage
  test:
    name: 2Ô∏è‚É£ Tests & Coverage
    uses: ./.github/workflows/test.yaml
    needs: build
    permissions:
      contents: write

  # 3Ô∏è‚É£ Auto PR vers dev (seulement pour feature/fix/hotfix/refactor)
  auto-pr:
    name: 3Ô∏è‚É£ Cr√©ation automatique de la PR
    runs-on: ubuntu-latest
    needs: test
    if: |
      github.event_name == 'push' &&
      (startsWith(github.ref, 'refs/heads/feature/') ||
       startsWith(github.ref, 'refs/heads/fix/') ||
       startsWith(github.ref, 'refs/heads/hotfix/') ||
       startsWith(github.ref, 'refs/heads/refactor/'))
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number=$(gh pr list --head ${{ github.ref_name }} --base dev --json number --jq '.[0].number // empty')
          if [ -n "$pr_number" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
            echo "‚úÖ PR #$pr_number already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "üîç No existing PR found"
          fi

      - name: Create Pull Request to dev
        if: steps.check.outputs.exists == 'false'
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ github.ref_name }}
          destination_branch: dev
          pr_title: '[${{ github.ref_name }}] Auto PR to dev'
          pr_body: |
            ## ü§ñ Automated Pull Request

            This PR was automatically created from branch `${{ github.ref_name }}` to `dev`.

            **Branch:** `${{ github.ref_name }}`
            **Target:** `dev`
            **Author:** @${{ github.actor }}
            **CI Status:** ‚úÖ Build & Tests passed

            Please review the changes and merge when ready.
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_draft: false
          pr_allow_empty: false

  # 4Ô∏è‚É£ Build & Push Docker (seulement pour dev/master/tags)
  docker:
    name: 4Ô∏è‚É£ Construction et Push Docker
    uses: ./.github/workflows/docker.yaml
    needs: test
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/master' || 
       github.ref == 'refs/heads/dev' ||
       startsWith(github.ref, 'refs/tags/v'))
    permissions:
      contents: read
      packages: write
    secrets: inherit
