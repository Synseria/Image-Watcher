# ============================================================================
# Workflow principal CI/CD (Intégration Continue / Déploiement Continu)
# ============================================================================
# Ce workflow orchestre l'ensemble du pipeline CI/CD en trois phases :
# 1. Compilation de l'application TypeScript
# 2. Exécution des tests et vérifications de qualité du code
# 3. Construction et publication de l'image Docker (uniquement pour certaines branches/tags)
#
# Déclenchement :
# - Sur chaque pull request (pour validation)
# - Sur chaque push de tag (pour release)
# ============================================================================

name: CI/CD

# Déclencheurs du workflow
on:
  push:
    tags: ['v*']  # S'exécute sur tous les tags commençant par 'v' (ex: v1.0.0)
    branches:
      - master  # Branche principale
      - dev     # Branche de développement
      - '**'    # Toutes les autres branches (pattern glob)
  pull_request:   # S'exécute sur toutes les pull requests
  workflow_dispatch: # Permet le déclenchement manuel (par auto-version-tag)

# Gestion de la concurrence pour éviter les conflits
# Si plusieurs exécutions du même workflow sont déclenchées sur la même référence,
# annule les exécutions précédentes encore en cours
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true  # Annule les exécutions précédentes en cours

# Variables d'environnement globales utilisées par les jobs
env:
  REGISTRY: ghcr.io                    # Registry Docker GitHub Container Registry
  IMAGE_NAME: ${{ github.repository }} # Nom de l'image au format owner/repo

jobs:
  # ==========================================================================
  # JOB 1 : Compilation de l'application TypeScript
  # ==========================================================================
  # Appelle le workflow réutilisable build.yaml qui compile le code TypeScript
  # et génère les fichiers JavaScript dans le dossier dist/
  build:
    name: Compilation
    uses: ./.github/workflows/build.yaml

  # ==========================================================================
  # JOB 2 : Tests et Couverture de Code
  # ==========================================================================
  # Appelle le workflow réutilisable test.yaml qui exécute :
  # - Les tests unitaires
  # - Le linter (vérification du style de code)
  # - La génération du rapport de couverture de code
  # 
  # Dépendance : Attend que le job 'build' soit terminé avec succès
  test:
    name: Tests et Couverture
    uses: ./.github/workflows/test.yaml
    needs: build  # Ne s'exécute que si le build réussit
    permissions:
      contents: write  # Nécessaire pour publier les rapports sur GitHub Pages

  # ==========================================================================
  # JOB 3 : Construction et Publication Docker
  # ==========================================================================
  # Appelle le workflow réutilisable docker.yaml qui construit l'image Docker
  # multi-architecture (amd64/arm64) et la publie sur GitHub Container Registry
  #
  # Conditions d'exécution :
  # - Uniquement sur un 'push' (pas sur pull_request)
  # - Uniquement pour les branches master, dev ou les tags de version
  #
  # Dépendance : Attend que le job 'test' soit terminé avec succès
  docker:
    name: Déploiement
    uses: ./.github/workflows/docker.yaml
    needs: test  # Ne s'exécute que si les tests passent
    
    # Condition : Pour push sur master/dev/tags OU pour workflow_dispatch sur un tag
    if: |
      (github.event_name == 'push' &&
       (github.ref == 'refs/heads/master' || 
        github.ref == 'refs/heads/dev' ||
        startsWith(github.ref, 'refs/tags/v'))) ||
      (github.event_name == 'workflow_dispatch' &&
       startsWith(github.ref, 'refs/tags/v'))
    
    permissions:
      contents: read   # Nécessaire pour lire le code source
      packages: write  # Nécessaire pour publier sur GitHub Container Registry
    
    secrets: inherit  # Hérite des secrets du workflow appelant
