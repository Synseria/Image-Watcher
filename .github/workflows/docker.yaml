# ============================================================================
# Workflow de Construction et Publication Docker
# ============================================================================
# Ce workflow réutilisable construit une image Docker multi-architecture
# (amd64/arm64) et la publie sur GitHub Container Registry (GHCR).
#
# Fonctionnalités principales :
# - Validation du format semver des tags
# - Construction multi-architecture (linux/amd64, linux/arm64)
# - Publication sur GHCR avec tags multiples selon la branche/tag
# - Mise en cache optimisée pour accélérer les builds
# ============================================================================

name: Docker

# Ce workflow est réutilisable et peut être appelé par d'autres workflows
on:
  workflow_call:

# Variables d'environnement globales
env:
  REGISTRY: ghcr.io                    # GitHub Container Registry
  IMAGE_NAME: ${{ github.repository }} # Format: owner/repo

jobs:
  # ==========================================================================
  # JOB 1 : Validation du Format Semver
  # ==========================================================================
  # Valide que le tag suit le format semver (vX.Y.Z ou vX.Y.Z-prerelease)
  # Ce job ne s'exécute que si le workflow est déclenché par un tag
  validate-tag:
    name: Valider le Tag Semver
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'  # Seulement si déclenché par un tag
    
    steps:
      # -----------------------------------------------------------------------
      # Validation du format semver avec regex
      # -----------------------------------------------------------------------
      # Vérifie que le tag correspond au format semver standard :
      # - v1.0.0 (release stable)
      # - v1.0.0-beta.1 (pre-release)
      # - v1.0.0-rc.2 (release candidate)
      - name: Valider le format semver
        run: |
          TAG="${{ github.ref_name }}"
          # Expression régulière pour valider le format semver
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "❌ ERREUR : Le tag '$TAG' n'est pas au format semver valide !"
            echo ""
            echo "✅ Exemples valides :"
            echo "   - v1.0.0"
            echo "   - v2.3.4"
            echo "   - v1.0.0-beta.1"
            echo "   - v1.2.3-rc.2"
            exit 1
          fi
          echo "✅ Le tag '$TAG' est un semver valide"

  # ==========================================================================
  # JOB 2 : Construction et Publication de l'Image Docker
  # ==========================================================================
  # Construit l'image Docker pour plusieurs architectures (amd64/arm64)
  # et la publie sur GitHub Container Registry avec plusieurs tags
  # 
  # Dépendance : Attend que le job validate-tag soit terminé ou ignoré
  docker:
    name: Construction et Publication
    runs-on: ubuntu-latest
    needs: [validate-tag]
    # S'exécute si validate-tag a réussi OU a été ignoré (pas de tag)
    if: always() && (needs.validate-tag.result == 'success' || needs.validate-tag.result == 'skipped')
    
    permissions:
      contents: read   # Nécessaire pour lire le code source
      packages: write  # Nécessaire pour publier sur GHCR
    
    steps:
      # -----------------------------------------------------------------------
      # Étape 1 : Récupération du code source
      # -----------------------------------------------------------------------
      - name: Récupération du code
        uses: actions/checkout@v5

      # -----------------------------------------------------------------------
      # Étape 2 : Configuration de QEMU
      # -----------------------------------------------------------------------
      # QEMU permet de construire des images pour différentes architectures
      # (ex: construire une image ARM64 sur une machine AMD64)
      - name: Configuration de QEMU
        uses: docker/setup-qemu-action@v3

      # -----------------------------------------------------------------------
      # Étape 3 : Configuration de Docker Buildx
      # -----------------------------------------------------------------------
      # Buildx est nécessaire pour les builds multi-architecture et les
      # fonctionnalités avancées comme la mise en cache
      - name: Configuration de Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # Étape 4 : Connexion à GitHub Container Registry
      # -----------------------------------------------------------------------
      # Authentification requise pour publier l'image sur GHCR
      - name: Connexion à GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}         # Utilisateur GitHub déclenchant le workflow
          password: ${{ secrets.GITHUB_TOKEN }} # Token généré automatiquement

      # -----------------------------------------------------------------------
      # Étape 5 : Extraction des métadonnées et génération des tags
      # -----------------------------------------------------------------------
      # Génère automatiquement les tags Docker en fonction du contexte :
      # - Tags semver (v1.0.0, v1.0, v1) pour les releases
      # - Tags master/latest pour la branche master
      # - Tags dev pour la branche dev
      # - Tags SHA pour traçabilité
      - name: Extraction des métadonnées
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Tags pour releases semver (ex: v1.2.3 → v1.2.3, v1.2, v1)
            type=semver,pattern=v{{version}},enable=${{ github.ref_type == 'tag' }}
            type=semver,pattern=v{{major}}.{{minor}},enable=${{ github.ref_type == 'tag' }}
            type=semver,pattern=v{{major}},enable=${{ github.ref_type == 'tag' }}
            type=raw,value=stable,enable=${{ github.ref_type == 'tag' }}
            
            # Tags pour la branche master
            type=raw,value=master,enable=${{ github.ref == 'refs/heads/master' }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' }}
            type=sha,prefix=master-,enable=${{ github.ref == 'refs/heads/master' }}
            
            # Tags pour la branche dev
            type=raw,value=dev,enable=${{ github.ref == 'refs/heads/dev' }}
            type=sha,prefix=dev-,enable=${{ github.ref == 'refs/heads/dev' }}
            
            # Tag SHA pour autres branches
            type=sha,prefix=${{ github.ref_name }}-,enable=${{ github.ref != 'refs/heads/master' && github.ref != 'refs/heads/dev' && github.ref_type != 'tag' }}

      # -----------------------------------------------------------------------
      # Étape 6 : Construction et publication de l'image Docker
      # -----------------------------------------------------------------------
      # Construit l'image pour amd64 et arm64, puis la publie sur GHCR
      # avec tous les tags générés à l'étape précédente
      - name: Construction et publication de l'image Docker
        uses: docker/build-push-action@v6
        with:
          context: .                                    # Utilise le répertoire courant
          file: ./Dockerfile                            # Chemin vers le Dockerfile
          platforms: linux/amd64,linux/arm64            # Architectures cibles
          push: true                                    # Publie l'image après construction
          tags: ${{ steps.meta.outputs.tags }}          # Tags générés par metadata-action
          labels: ${{ steps.meta.outputs.labels }}      # Labels de métadonnées
          cache-from: type=gha                          # Utilise le cache GitHub Actions
          cache-to: type=gha,mode=max                   # Sauvegarde le cache (mode max = tous les layers)
